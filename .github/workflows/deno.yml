#/
# @license Apache-2.0
#
# Copyright (c) 2022 The Stdlib Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#/

# Workflow name:
name: deno

# Workflow triggers:
on:
  workflow_dispatch:

# Workflow jobs:
jobs:
  publish-deno:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Copy files to deno directory
        run: |
          mkdir -p deno
          cp README.md LICENSE CONTRIBUTORS NOTICE index.d.ts deno
      - name: Rewrite README.md file
        run: |
          # Replace internal package links with deno.land links:
          find ./deno -type f -name '*.md' -print0 | xargs -0 sed -Ei "/^\[@stdlib[^:]+: https:\/\/github.com\/stdlib-js\// {
              h
              s/:.*/: https:\/\/deno.land\/x\/stdlib_/
              x
              s/[^:]+: https:\/\/github.com\/stdlib-js\///
              s/[\/-]/_/g
              H
              g
              s/\n//
          }"

          # Change wording of project description to avoid reference to JavaScript and Node.js:
          find ./deno -type f -name \'*.md\' -print0 | xargs -0 sed -Ei "s/a standard library for JavaScript and Node.js, /a standard library /g"

          # Remove `installation`, `cli`, and `c` sections:
          find ./deno -type f -name '*.md' -print0 | xargs -0 perl -0777 -i -pe "s/<section class=\"installation\">[^<]+<\/section>//g;"
          find ./deno -type f -name '*.md' -print0 | xargs -0 perl -0777 -i -pe "s/<section class=\"cli\">[\s\S]+<\!\-\- \/.cli \-\->//g"
          find ./deno -type f -name '*.md' -print0 | xargs -0 perl -0777 -i -pe "s/<section class=\"c\">[\s\S]+<\!\-\- \/.c \-\->//g"

      - name: Prepare tag
        id: prepare_tag
        run: |
          TAG_NAME="v0.0.3"
          echo "::set-output name=tag_name::${TAG_NAME}"
          echo "::set-output name=publish_tag_name::deno-${TAG_NAME}"
      - name: Publish to deno branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deno
          publish_branch: deno
          keep_files: false
          user_name: 'stdlib-bot'
          user_email: 'noreply@stdlib.io'
          tag_name: ${{ steps.prepare_tag.outputs.publish_tag_name }}
          tag_message: 'Release ${{ steps.prepare_tag.outputs.tag_name }}'
          commit_message: ${{ steps.prepare_tag.outputs.tag_name }}
          enable_jekyll: true
